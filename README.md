# Bond Reporting Platform

Это микросервисное приложение, которое интегрируется с Telegram Bot и другими клиентскими приложениями
для получения информации из T-Инвестиций. Приложение обрабатывает данные и формирует отчёты по облигациям, предоставляя пользователю актуальную финансовую информацию через Telegram.

---

## Основные возможности

- Получение запросов от Telegram Bot

- Подключение к API Tinkoff Инвестиций

- Обработка и агрегация данных по облигациям

- Формирование и отправка отчётов пользователю

- Микросервисная архитектура для удобного масштабирования

- Чёткое разделение ответственности между сервисами

- Возможность расширения под другие источники данных и клиентские интерфейсы

## Запуск

### Требования

- Go ≥ 1.24
- Docker + Docker Compose
- make

---

### Использование Makefile

В проекте используется `Makefile`, который инкапсулирует основные сценарии запуска, тестирования и проверки качества кода.
```markdown
> На Windows рекомендуется использовать WSL.
```

#### Основные команды

| Команда | Описание |
|-------|---------|
| `make up` | Запуск продакшн-контейнеров |
| `make build-up` | Сборка и запуск продакшн-контейнеров |
| `make down` | Остановка продакшн-контейнеров и удаление томов |

---

### Примеры запуска

#### Продакшн

##### Запуск

```bash
make build-up
```
##### Остановка:
```bash
make down
```


## Описание переменных окружения (example.env)

```markdown
> Файл example.env описывает переменные окружения,
> используемые всеми сервисами системы.
```

### 1. Общие настройки окружения
| Переменная | Значение по умолчанию / пример | Описание                                                                                                                      |
| ---------- | ------------------------------ | ----------------------------------------------------------------------------------------------------------------------------- |
| `ENV`      | `dev`                          | Определяет среду запуска: `local`, `dev`, `prod`. От этого могут зависеть логи, конфигурации сервисов и поведение приложения. |

### 2. Telegram Bot

| Переменная        | Значение по умолчанию / пример | Описание                                                               |
| ----------------- | ------------------------------ | ---------------------------------------------------------------------- |
| `LOCAL_BOT_TOKEN` | `your_telegram_bot_token`      | Токен Telegram бота. Используется для авторизации бота в Telegram API. |

### 3. Порты микросервисов

| Переменная                 | Значение по умолчанию | Описание                                                             |
| -------------------------- | --------------------- | -------------------------------------------------------------------- |
| `MYAPP_PORT`               | 8080                  | Порт основного приложения / API шлюза.                               |
| `BOND_REPORT_SERVICE_PORT` | 8084                  | Порт сервиса генерации отчётов по облигациям.                        |
| `CBR_PORT`                 | 8083                  | Порт сервиса работы с Центральным Банком России (курсы валют и др.). |
| `TINKOFF_API_PORT`         | 8082                  | Порт сервиса работы с API Tinkoff Инвестиций.                        |
| `MOEX_API_PORT`            | 8081                  | Порт сервиса работы с MOEX API (информация о рынках).                |

### 4. Redis

| Переменная         | Значение по умолчанию | Описание                                                  |
| ------------------ | --------------------- | --------------------------------------------------------- |
| `REDIS_PASSWORD`   | `your_redis_password` | Пароль для подключения к Redis.                           |
| `REDIS_PORT`       | 6379                  | Порт для стандартного подключения к Redis.                |
| `REDIS_STACK_PORT` | 8001                  | Порт для Stack API / Dashboard Redis (если используется). |

### 5. Ключ шифрования

| Переменная | Значение по умолчанию | Описание                                                                                                             |
| ---------- | --------------------- | -------------------------------------------------------------------------------------------------------------------- |
| `KEY`      | `your_base64_key`     | Секретный ключ в Base64, используется для шифрования токенов и данных. Создаётся командой `openssl rand -base64 32`. |

### 6. PostgreSQL – пользователи

| Переменная                | Значение по умолчанию | Описание                                                |
| ------------------------- | --------------------- | ------------------------------------------------------- |
| `POSTGRES_USER_PORT`      | 5433                  | Порт для подключения к БД пользователей.                |
| `POSTGRES_USERS_PASSWORD` | `your_postrges_parol` | Пароль пользователя PostgreSQL.                         |
| `POSTGRES_USERS_DB`       | `your_db_name`        | Имя базы данных пользователей.                          |
| `POSTGRES_USERS_USER`     | `your_user_name`      | Имя пользователя PostgreSQL для сервиса пользователей.  |
| `USERS_PGUSER`            | `your_pguser_name`    | Имя пользователя PostgreSQL, используемое в приложении. |


### 7. PostgreSQL – сервис

| Переменная                  | Значение по умолчанию | Описание                                                                         |
| --------------------------- | --------------------- | -------------------------------------------------------------------------------- |
| `POSTGRES_SERVICE_PORT`     | 5432                  | Порт для подключения к сервисной базе данных (например, для отчетов и сервисов). |
| `POSTGRES_SERVICE_PASSWORD` | `your_postrges_parol` | Пароль PostgreSQL для сервисной базы.                                            |
| `POSTGRES_SERVICE_DB`       | `your_db_name`        | Имя сервисной базы данных.                                                       |
| `POSTGRES_SERVICE_USER`     | `your_user_name`      | Имя пользователя PostgreSQL для сервисной базы.                                  |
| `SERVICE_PGUSER`            | `your_pguser_name`    | Имя пользователя PostgreSQL, используемое приложением для сервисной базы.        |


## Архитектура

Приложение представляет собой набор микросервисов, взаимодействующих друг с другом для обработки запросов Telegram-бота и генерации отчетов по облигациям пользователя Tinkoff Инвестиций.

1) **Myapp(Gateway Service)**

- Основной сервис для взаимодействия с Telegram Bot.
- Обрабатывает входящие сообщения от пользователей.
- Инициирует аутентификацию пользователя по токену T-Invest, делая запрос в T-Connector и сохраняет его в Redis.
- Сохраняет данные чата, имя пользователя и токен в PostgreSQL.
- Перенаправляет запросы к Report Service и возвращает сформированные ответы в Telegram Bot.

2) **Bond-report-service(Report Service)** 

- Сервис, реализующий основную бизнес-логику приложения.
- Получает запросы от Gateway Service.
- Взаимодействует с внутренними сервисами T-Connector, Moex Connector и Cbr Connector, которые, в свою очередь, работают с внешними источниками данных (Tinkoff Invest API, MOEX API, сайт ЦБ РФ)
- Обрабатывает и агрегирует данные, полученные через connector-сервисы.
- Сохраняет промежуточные и итоговые данные в PostgreSQL.
- Формирует отчеты в формате JSON и возвращает их Gateway Service для передачи пользователю.

3) **TinkoffApi(T-Connector)** 

- Сервис для работы с T-Invest API.
- Получает запросы от Gateway Service и Report Service.
- Выполняет аутентификацию пользователя по токену T-Invest, переданному в заголовках HTTP-запроса(при запросах от Gateway Service).
- Использует chatID из заголовка запроса для получения токена из Redis (при запросах от Report Service).
- Отправляет запросы к внешнему T-Invest API и возвращает результаты в формате JSON.

4) **MoexApi(Moex Connector)**

- Сервис для работы с MOEX API.
- Получает запросы от Report Service.
- Запрашивает данные с MOEX API и возвращает результаты в формате JSON. 

5) **CbrApi(Cbr Connector)**

- Сервис для работы с данными Центрального Банка РФ.
- Получает запросы от Report Service.
- Парсит данные с сайта ЦБ РФ и возвращает их в формате JSON.

**Общие особенности**

- Все сервисы могут работать как независимо друг от друга, так и совместно через Docker Compose для локальной разработки.
- Взаимодействие между сервисами осуществляется по HTTP.
- Redis и PostgreSQL используются для хранения токенов, сессий и агрегированных данных.

## Возможные расширения
- Полное покрытие приложения автоматическими тестами (unit, integration, e2e)
- Рефакторинг кода с выделением интерфейсов и явных контрактов между слоями
- Асинхронная обработка ресурсоёмких задач(генерация отчётов, агрегация данных, расчёты)
- Расширение набора отчётов:
  - Анализ лучших и худших закрытых позиций за выбранный период
  - Топ-5 выросших и снизившихся инструментов в портфеле за день
  - Суммарный рост / убыток портфеля в разрезе годов
  - Отчёты по акциям, фьючерсам и ETF
- Внедрение централизованной системы логирования(Fluentd + OpenSearch + OpenSearch Dashboards)
- Реализация сквозной трассировки запросов между микросервисами(distributed tracing)
